<style>
  table#cal tr.days td {
    width: 22px;
    text-align: center;
    font-weight: bold;
    padding: 0;
  }

  td.weekend {
    border: solid 1px #888888;
/*    background-color: #ffcccc !important;*/
    background-image: url(/images/ffcccc.png);
  }
  td.weekend.selected {
    border: solid 1px #888888;
    background: url(/images/smiley-eek-ffcccc.png) no-repeat center;
  }


  table#cal {
    border: solid 2px black;
  }

  table#cal thead td {
    background-color: white !important;
  }

  table#cal thead td.weekend {
    background-color: #ffcccc !important;
  }

  td.rb { border-right:  solid 2px black }
  td.bb, tr.bb { border-bottom: solid 2px black }

  table#cal td.selected {
    background: url(/images/smiley-eek.png) no-repeat center;
  }

  tbody#cal_tbody td { cursor: pointer }

  td.vacation {
    text-align: center;
    color: grey;
    background-color: lightgrey;
  }
</style>

<%= calendar_date_select_includes %>

<table id="cal" class="t1">
  <thead>
    <tr class="days bb">
      <td class="rb"></td>
      <% (@start_date..@end_date).each do |date| %>
        <%- wday_td(date) do -%>
          <%= date.day -%>
        <%- end -%>
      <% end %>
    </tr>
  </thead>
  <tbody id="cal_tbody">
    <% @users.each do |user| %>
      <tr>
        <td class="rb username"><%=link_to_user(user)%></td>
        <% (@start_date..@end_date).each do |date| %>
          <% if @vacations_by_user_id[user.id] && (vacation = @vacations_by_user_id[user.id].find{|v| v.include?(date) }) %>
            <%= draw_vacation(vacation, date) -%>
          <% else %>
            <%- wday_td(date, 'wday') do -%>
            <%- end -%>
          <% end %>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<ul class="tasks">
  <li><%= link_to_function "&raquo; добавить отпуск" do |page|
            page.visual_effect :toggle_blind, :vacation_form, :duration => 0.2
          end %>
    <% form_tag( {:action => 'add_vacation'},
        :id => 'vacation_form',
        :style => 'display:none; margin: 5px 0 0 18px'
       ) do %>
        <%= select_tag 'user_id', options_for_select(@users.sort_by(&:name).map{ |u| [u.name,u.id] }) %>
        <%= calendar_date_select_tag "start_date", nil, :size => 10 %>
        <%= calendar_date_select_tag "end_date",   nil, :size => 10 %>
        <%= submit_tag 'Добавить', :name => nil %>
        <p class="clear"></p>
    <% end %>

</ul>

<%= javascript_tag <<-EOJS
  Sortable.create("cal_tbody", {tag:"tr", ghosting:true, handle:"username"});

  Event.observe('cal','click',function(ev){
    var td = ev.element();
    if( td.tagName != 'TD' || !td.hasClassName('wday') ) return;
    if( td.hasClassName('selected') ){
      td.removeClassName('selected');
    } else {
      td.addClassName('selected');
      if(td.previousElementSibling){
        td.previousElementSibling.removeClassName('selected');
      }
      if(td.nextElementSibling){
        td.nextElementSibling.removeClassName('selected');
      }
      checkCol(td);
    }
  });

  // checks the table column to have the only _one_ instance of selected cell
  function checkCol(td){
    var ci       = td.cellIndex;
    var ri       = td.parentNode.rowIndex;
    var tbody    = td.parentNode.parentNode;
    var tbody_cl = tbody.children.length;
    for(var i=0; i<tbody_cl; i++){
      var tr = tbody.children[i];
      if( tr.rowIndex == ri ) continue;
      tr.children[ci].removeClassName('selected');
    }
  }
EOJS
%>
